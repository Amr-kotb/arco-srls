<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ARCO SRLS - Attrezzi Cantiere Watt</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#0b1e3f; color:white; padding:20px; }
h1 { text-align:center; margin-bottom:30px; color:#00ffaa; }
.grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px;}
.card{background:#082b5c;border-radius:12px;display:flex;flex-direction:column;align-items:center;padding:15px;text-align:center;min-height:260px;}
.card img{width:190px;height:140px;object-fit:contain;margin-bottom:10px;border-radius:8px;}
.quantity-container{display:flex;justify-content:center;align-items:center;gap:8px;margin-top:auto;}
.quantity-container button{background:#00ffaa;color:#003366;border:none;padding:6px 12px;font-size:16px;cursor:pointer;border-radius:6px;transition:0.3s;}
.quantity-container button:hover{background:#00cc88;}
.quantity-container input{width:45px;text-align:center;font-size:16px;border:2px solid #003366;border-radius:6px;}
.top-buttons { text-align:center; margin-bottom:20px; }
.top-buttons button { margin: 0 5px; padding: 10px 20px; border: none; border-radius: 8px; background: #00ffaa; color: #0b1e3f; font-weight: bold; cursor: pointer; }
.top-buttons button:hover { background: #00cc88; }

/* Riepilogo */
.riepilogo {
  margin-top:40px;
  background:#082b5c;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.5);
}
.riepilogo h2 {
  color:#00ffaa;
  text-align:center;
  margin-bottom:15px;
}
.riepilogo ul {
  list-style:none;
  padding:0;
  margin:0;
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap:10px 20px;
}
.riepilogo li {
  font-size:16px;
  padding:6px 10px;
  background:#0b1e3f;
  border-radius:8px;
  text-align:center;
}
</style>
</head>
<body>

<div class="top-buttons">
  <button onclick="window.location.href='index.html'">üè† Home Page</button>
</div>

<h1>WATT Attrezzi</h1>
<div class="grid" id="gridAttrezzi"></div>

<!-- üîπ Riepilogo sotto -->
<div class="riepilogo">
  <h2>Riepilogo Quantit√†</h2>
  <ul id="riepilogoList"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, doc, onSnapshot, updateDoc, increment, setDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "TUO_API_KEY",
  authDomain: "TUO_PROGETTO.firebaseapp.com",
  projectId: "TUO_PROGETTO",
  storageBucket: "TUO_PROGETTO.appspot.com",
  messagingSenderId: "xxx",
  appId: "xxx"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const cantiereID = "watt";
const attrezzi = ["Avvitatore","Trapano","Laser","Batteria","Carica Batteria","Seghetto","Sparachiodi","Smerigliatrice"];
const container = document.getElementById('gridAttrezzi');
const riepilogoList = document.getElementById('riepilogoList');
let dataQuantities = {};

// Assicuriamoci che il documento esista
const docRef = doc(db,"cantieri",cantiereID);
setDoc(docRef, {}, { merge: true });

// Crea le card attrezzi
attrezzi.forEach(att => {
  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `
    <img src="./attrezzi/${att.toLowerCase()}.png" alt="${att}">
    <h2>${att}</h2>
    <div class="quantity-container">
      <button>-</button>
      <input type="number" value="0" min="0">
      <button>+</button>
    </div>`;
  container.appendChild(card);

  const input = card.querySelector('input');
  const btnInc = card.querySelectorAll('button')[1];
  const btnDec = card.querySelectorAll('button')[0];

  // Incremento/Decremento con update atomico
  btnInc.onclick = () => incrementQuantity(att, 1);
  btnDec.onclick = () => incrementQuantity(att, -1);
  input.onchange = () => setQuantity(att, parseInt(input.value));
});

// Listener realtime Firestore
onSnapshot(docRef, snap => {
  if(snap.exists()){
    dataQuantities = snap.data();

    // Aggiorna input nelle card senza sovrascrivere gli altri utenti
    attrezzi.forEach(att => {
      const card = [...container.children].find(c => c.querySelector('h2').textContent===att);
      card.querySelector('input').value = dataQuantities[att] || 0;
    });

    // Aggiorna riepilogo
    aggiornaRiepilogo();
  }
});

// Funzione per incrementare/decrementare atomico
async function incrementQuantity(att, amount){
  const fieldUpdate = {};
  fieldUpdate[att] = increment(amount);
  await updateDoc(docRef, fieldUpdate);
}

// Funzione per impostare quantit√† precisa
async function setQuantity(att, value){
  const fieldUpdate = {};
  fieldUpdate[att] = value;
  await updateDoc(docRef, fieldUpdate);
}

// Funzione per aggiornare il riepilogo
function aggiornaRiepilogo(){
  riepilogoList.innerHTML = "";
  attrezzi.forEach(att => {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${att}</strong>: ${dataQuantities[att] || 0}`;
    riepilogoList.appendChild(li);
  });
}
</script>
</body>
</html>
